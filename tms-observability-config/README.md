# TMS Observability Configuration (REPO-TMS-OBS)

This repository contains the version-controlled configurations for the entire observability stack of the Transport Management System (TMS). It embodies the "Observability as Code" philosophy, ensuring that our monitoring, logging, and alerting strategies are auditable, repeatable, and managed with the same rigor as our application code.

This repository provides the declarative configurations for the following tools, as mandated by requirement `REQ-1-602`:
-   **Prometheus**: For metrics collection and defining alerting rules.
-   **Alertmanager**: For routing and managing alerts generated by Prometheus.
-   **Grafana**: For visualizing metrics and logs in dashboards.
-   **Fluent Bit**: For collecting, parsing, and forwarding container logs to OpenSearch.

## Repository Structure

The repository is organized by tool to maintain a clear separation of concerns.

```
.
├── .github/workflows/        # CI/CD pipelines
│   └── validate-configs.yml
├── .vscode/                  # Recommended VSCode extensions and settings
├── fluentbit/                # Fluent Bit configuration files
│   ├── filters/filters.conf
│   ├── outputs/outputs.conf
│   └── parsers/parsers.conf
├── grafana/                  # Grafana dashboards and provisioning
│   ├── dashboards/
│   │   ├── gps-microservice.json
│   │   ├── log-explorer.json
│   │   ├── odoo-performance.json
│   │   └── tms-overview.json
│   └── provisioning/
│       ├── dashboards/provider.yml
│       └── datasources/prometheus-ds.yml
├── prometheus/               # Prometheus and Alertmanager configurations
│   ├── alertmanager/alertmanager.yml
│   └── rules/
│       ├── application.rules.yml
│       ├── platform.rules.yml
│       └── recording.rules.yml
├── scripts/                  # Validation and utility scripts
│   └── validate-configs.sh
├── .editorconfig
├── .gitignore
├── .yamllint                 # Configuration for YAML linter
├── fluent-bit.conf           # Main Fluent Bit configuration file
├── prometheus.yml            # Main Prometheus configuration file
└── README.md
```

### Key Components

-   **`prometheus/`**:
    -   `prometheus.yml`: Defines global settings and service discovery for scraping metrics from application endpoints (`/metrics`).
    -   `alertmanager/alertmanager.yml`: Configures alert routing, grouping, and receivers (e.g., Slack, PagerDuty).
    -   `rules/`: Contains all alerting and recording rules.
        -   `application.rules.yml`: Alerts for application-specific SLOs (e.g., high API error rates, latency), as per `REQ-1-602`.
        -   `platform.rules.yml`: Alerts for underlying platform/infrastructure issues (e.g., Kubernetes pod crashes, high CPU).
        -   `recording.rules.yml`: Pre-calculates expensive or frequently used PromQL queries to improve dashboard and alert performance.

-   **`grafana/`**:
    -   `dashboards/`: Stores dashboard definitions as JSON models. This allows us to version-control our dashboards.
    -   `provisioning/`: Configuration files that tell Grafana how to automatically load the datasources and dashboards from this repository on startup.

-   **`fluentbit/`**:
    -   `fluent-bit.conf`: The main entrypoint for the logging agent configuration, which uses `@INCLUDE` to load the modular pipeline components.
    -   `parsers/`: Defines how to parse log lines. Crucially, it includes a JSON parser to handle the structured logs from our applications (`REQ-1-680`).
    -   `filters/`: Defines transformations, such as adding Kubernetes metadata (pod name, namespace) to logs.
    -   `outputs/`: Defines where to send the processed logs (e.g., the OpenSearch cluster).

-   **`scripts/`**:
    -   `validate-configs.sh`: A critical script for ensuring all configurations are valid before they are merged.

## Local Development & Validation

To contribute changes, it's essential to validate them locally before creating a pull request.

### Prerequisites

You need the following command-line tools installed and available in your `PATH`:
-   `promtool` (comes with Prometheus)
-   `fluent-bit`
-   `yamllint`
-   `jq`

A recommended approach is to use a Docker container that has these tools pre-installed to ensure a consistent environment.

### Running Validation

From the root of the repository, execute the validation script:

```bash
chmod +x scripts/validate-configs.sh
./scripts/validate-configs.sh
```

The script will check all Prometheus rules, Alertmanager configuration, Fluent Bit pipeline, Grafana dashboard JSON syntax, and general YAML file syntax. If any check fails, the script will exit with an error, indicating the file and issue.

## CI/CD Integration

This repository is configured with a GitHub Actions workflow (`.github/workflows/validate-configs.yml`) that automatically runs the `scripts/validate-configs.sh` script on every pull request targeting the `main` branch.

**No pull request will be merged if the validation checks fail.** This ensures the integrity of our observability configurations and prevents broken changes from being deployed.

## Secrets Management

**This repository MUST NOT contain any secrets.**

In compliance with `REQ-1-503`, sensitive information such as API keys for notifiers (Slack), passwords for datasources, or any other credentials must not be hardcoded.

Configurations should use placeholders that can be substituted by environment variables at runtime. The deployment process (managed in `REPO-TMS-K8S`) is responsible for fetching these secrets from **AWS Secrets Manager** and injecting them into the environment of the respective service containers (Prometheus, Grafana, etc.).

## Contribution Workflow

1.  Create a new feature branch from `main`.
2.  Make your configuration changes.
3.  Run the validation script locally to ensure all checks pass: `./scripts/validate-configs.sh`.
4.  Commit your changes and push the branch to the remote repository.
5.  Create a Pull Request against the `main` branch.
6.  Ensure the automated CI checks pass.
7.  Request a review from the repository maintainers.