# -------------------------------------------------------------------
# Fluent Bit - Outputs Configuration
# -------------------------------------------------------------------
# This file defines the output destination for processed log records.
# It is included by the main fluent-bit.conf.
#
# Primary Output: OpenSearch
# - This configuration sends all matched logs to a centralized OpenSearch cluster.
# - It uses environment variables for credentials to comply with REQ-1-503.
# - It creates daily indices, a best practice for log management and retention.
# - It configures buffering and retries for resilient log delivery.
#
# @INCLUDE outputs/outputs.conf
# -------------------------------------------------------------------

[OUTPUT]
    # Name of the output plugin
    Name                opensearch

    # Match all log records. This will be the final destination for all logs.
    Match               *

    # OpenSearch cluster endpoint.
    # These values MUST be provided as environment variables during deployment.
    Host                ${OPENSEARCH_HOST}
    Port                ${OPENSEARCH_PORT}

    # OpenSearch credentials.
    # These MUST be provided from a secure source like AWS Secrets Manager (REQ-1-503).
    HTTP_User           ${OPENSEARCH_USER}
    HTTP_Passwd         ${OPENSEARCH_PASSWD}

    # Index name for the logs in OpenSearch.
    Index               tms-logs

    # Enable Logstash format for index creation.
    # This allows for time-based daily indices.
    Logstash_Format     On

    # Prefix for the daily index name. Fluent Bit will append the date.
    # e.g., tms-logs-2024.07.28
    Logstash_Prefix     tms-logs

    # The document type.
    Type                _doc

    # When a log record has a key matching this value, the value of that key
    # will be used as the document ID in OpenSearch. Helps prevent duplicates.
    # We can set this to 'trace_id' if our structured logs contain it.
    # Id_Key              trace_id

    # Buffering and Retry mechanism for resilient delivery.
    # If OpenSearch is temporarily unavailable, Fluent Bit will retry.
    Retry_Limit         5

    # Enable TLS for secure communication with OpenSearch.
    tls                 On

    # Verify the TLS certificate from the server. Set to Off for self-signed certs.
    # For production, this should be On, and `tls.ca_file` should be provided if needed.
    tls.verify          On

    # Suppress verbose connection messages from the output plugin.
    Suppress_Type_Name  On

    # Number of dedicated workers for this output plugin.
    Workers             2