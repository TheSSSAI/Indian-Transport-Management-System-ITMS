# ==============================================================================
# FLUENT BIT MAIN CONFIGURATION (fluent-bit.conf)
# ==============================================================================
# This is the main configuration file for the Fluent Bit logging agent.
# It defines the service-level settings and uses @INCLUDE directives to create
# a modular pipeline for processing container logs. This orchestrates the
# parsing, filtering, and outputting of logs as defined in REQ-1-602.
# ==============================================================================

[SERVICE]
    # --------------------------------------------------------------------------
    # Service Configuration Block
    # --------------------------------------------------------------------------
    # Interval to flush output buffer.
    Flush        5
    # Run Fluent Bit as a background service.
    Daemon       Off
    # Set the logging verbosity level.
    Log_Level    info
    # Define the path to the parsers configuration file.
    Parsers_File parsers/parsers.conf
    # Enable the built-in HTTP server for monitoring Fluent Bit itself.
    HTTP_Server  On
    HTTP_Listen  0.0.0.0
    HTTP_Port    2020
    # Configure storage for buffering. This helps prevent data loss if the
    # output (e.g., OpenSearch) is unavailable.
    storage.path            /var/fluent-bit/state/flb-storage/
    storage.sync            normal
    storage.checksum        off
    storage.backlog.mem_limit 50M

# ==============================================================================
# INPUT STAGE: Tailing Container Logs
# ==============================================================================
# This block defines the source of the logs. We use the 'tail' plugin to
# read all container logs generated by the container runtime on the EKS node.
# ==============================================================================

[INPUT]
    # Plugin name.
    Name              tail
    # A friendly tag for logs coming from this input.
    Tag               kube.*
    # Path to the container log files. The wildcard captures logs from all pods.
    Path              /var/log/containers/*.log
    # Specify the parser to use for these logs. We will use the 'cri' parser
    # to handle the container runtime's log format, which encapsulates our
    # application's JSON log line.
    Parser            cri
    # Database file to keep track of file offsets.
    DB                /var/fluent-bit/state/flb_kube.db
    # Maximum memory buffer limit for this input.
    Mem_Buf_Limit     5MB
    # Skip log entries that are longer than a specified size.
    Skip_Long_Lines   On
    # Refresh interval for checking new files in the path.
    Refresh_Interval  10
    # Enable reading from the beginning of the files on startup.
    Read_from_Head    True

# ==============================================================================
# INCLUDE DIRECTIVES: Building the Processing Pipeline
# ==============================================================================
# These directives load the modular configuration files for filtering and
# outputting the logs, creating a complete and maintainable pipeline.
# ==============================================================================

# Include the filtering configuration (e.g., Kubernetes metadata enrichment).
@INCLUDE filters/filters.conf

# Include the output configuration (e.g., forwarding to OpenSearch).
@INCLUDE outputs/outputs.conf