# -------------------------------------------------------------------
# Fluent Bit - Filters Configuration
# -------------------------------------------------------------------
# This file defines the filter pipeline for processing log records.
# It is included by the main fluent-bit.conf.
#
# Primary Filter: Kubernetes Metadata Enrichment
# - This filter enriches logs with metadata from the Kubernetes API server,
#   such as pod name, namespace, labels, and annotations.
# - This is critical for filtering and searching logs in OpenSearch/Grafana.
# - It fulfills the requirement for a comprehensive logging stack (REQ-1-602).
#
# @INCLUDE filters/filters.conf
# -------------------------------------------------------------------

[FILTER]
    # Name of the filter plugin
    Name                kubernetes

    # Match all log records tagged with 'kube.*' which is the standard
    # from the 'tail' input plugin reading container logs.
    Match               kube.*

    # Kubernetes API Server endpoint.
    # When running within a pod, this is the default service endpoint.
    Kube_URL            https://kubernetes.default.svc:443

    # Kubelet endpoint. Used for fetching metadata if the API server is slow.
    # Set to false as we are relying on the API server for full metadata.
    Kubelet_Host        ${KUBELET_HOST}
    Kubelet_Port        10250

    # Prefix of the log tag that contains the container info.
    # The tail input plugin tags logs as kube.var.log.containers.<pod_name>_<namespace>...
    Kube_Tag_Prefix     kube.var.log.containers.

    # Merge the JSON log body into the top-level of the record.
    # This is crucial for working with structured JSON logs (REQ-1-680).
    # If the log is {"level": "info", "message": "hello"}, after this filter,
    # the record will have top-level keys 'level' and 'message'.
    Merge_Log           On

    # When Merge_Log is On, the original 'log' field is kept.
    # Set to Off to avoid duplication and reduce storage.
    Keep_Log            Off

    # Enable/disable K8s-specific annotations for lookup.
    # Can be used to control parsing or other behaviors based on pod annotations.
    K8S-Logging.Parser  On
    K8S-Logging.Exclude Off

    # Cache settings for Kubernetes metadata to reduce load on the API server.
    # Time in seconds to expire the cache for pods and namespaces.
    Cache_Use_Kubelet   On
    Kube_Meta_Cache_TTL 300s

    # Add Kubernetes labels and annotations to the log record.
    # This is essential for searching and filtering logs by application, owner, etc.
    Labels              On
    Annotations         On