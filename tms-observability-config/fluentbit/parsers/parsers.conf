# fluentbit/parsers/parsers.conf
# This file defines the log parsers used in the Fluent Bit pipeline.
# REQ-1-680 requires that application logs are in structured JSON format.

[PARSER]
    # Name for the parser, to be referenced in the input configuration.
    Name        tms_json_parser
    # Specifies that we are using the built-in JSON parser.
    Format      json
    # Specifies the field in the JSON payload that contains the log's timestamp.
    # All applications MUST log with a 'timestamp' field.
    Time_Key    timestamp
    # Specifies the format of the timestamp. This is a common ISO 8601 format with timezone.
    # Example: 2024-07-29T10:30:00.123+0000
    Time_Format %Y-%m-%dT%H:%M:%S.%L%z
    # If the time key is not found, keep the original record but don't parse the time.
    Time_Keep   On

[PARSER]
    # A standard parser for CRI (Container Runtime Interface) logs,
    # which wrap the application's JSON output. This extracts the actual log message
    # which can then be passed to the tms_json_parser.
    Name        cri
    Format      regex
    Regex       ^(?<time>[^ ]+) (?<stream>stdout|stderr) (?<logtag>[^ ]*) (?<log>.*)$
    Time_Key    time
    Time_Format %Y-%m-%dT%H:%M:%S.%N%z

[PARSER]
    # Docker/containerd default JSON log format parser
    Name        docker
    Format      json
    Time_Key    time
    Time_Format %Y-%m-%dT%H:%M:%S.%N%z
    # The actual log message is nested in the 'log' field.
    Decode_Field_As json log